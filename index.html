<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Super Cat Tuna Quest 3D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #gui {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 15px;
            border: 2px solid #ffcc00; pointer-events: none;
        }
        .stat { font-size: 1.5rem; font-weight: bold; color: #ffcc00; }
        #msg { position: absolute; top: 50%; width: 100%; text-align: center; color: white; font-size: 2rem; display: none; }
    </style>
</head>
<body>
    <div id="gui">
        <div class="stat">Atún: <span id="score">0</span></div>
        <div style="font-size: 0.9rem; margin-top: 5px;">Saltar: ESPACIO | Mover: A - D</div>
    </div>
    <div id="msg">¡POWER UP! ⚡</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- MOTOR DE JUEGO ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        scene.fog = new THREE.Fog(0x1a1a2e, 5, 45);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LUCES ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(5, 10, 7);
        sun.castShadow = true;
        scene.add(sun);

        // --- ESTADO DEL JUEGO ---
        let cat = null;
        let score = 0;
        let isPowerUp = false;
        const items = [];
        const obstacles = [];
        const keys = { a: false, d: false, space: false };
        const player = { velY: 0, speed: 0.15, isGrounded: false };

        // --- CREACIÓN DEL MUNDO ---
        const floorGeo = new THREE.BoxGeometry(200, 1, 6);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x222244 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.position.y = -0.5;
        floor.receiveShadow = true;
        scene.add(floor);

        // Generar latas y obstáculos
        function createWorld() {
            const tunaGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const tunaMat = new THREE.MeshStandardMaterial({ color: 0xffcc00, metalness: 0.8, roughness: 0.2 });
            const obsGeo = new THREE.BoxGeometry(1, 2, 1);
            const obsMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });

            for (let i = 1; i < 20; i++) {
                // Latas de atún
                const tuna = new THREE.Mesh(tunaGeo, tunaMat);
                tuna.position.set(i * 5 + Math.random() * 2, 1, 0);
                tuna.rotation.x = Math.PI / 2;
                scene.add(tuna);
                items.push(tuna);

                // Obstáculos
                if (i % 3 === 0) {
                    const obs = new THREE.Mesh(obsGeo, obsMat);
                    obs.position.set(i * 5 + 3, 1, 0);
                    scene.add(obs);
                    obstacles.push(obs);
                }
            }
        }
        createWorld();

        // --- CARGAR GATO ---
        const loader = new GLTFLoader();
        // Asegúrate de que el archivo se llame gato.glb
        loader.load('./gato.glb', (gltf) => {
            cat = gltf.scene;
            cat.scale.set(0.6, 0.6, 0.6);
            cat.traverse(n => { if (n.isMesh) n.castShadow = true; });
            scene.add(cat);
        });

        // --- CONTROLES ---
        window.onkeydown = (e) => { 
            if(e.code === 'KeyA') keys.a = true; 
            if(e.code === 'KeyD') keys.d = true; 
            if(e.code === 'Space') keys.space = true; 
        };
        window.onkeyup = (e) => { 
            if(e.code === 'KeyA') keys.a = false; 
            if(e.code === 'KeyD') keys.d = false; 
            if(e.code === 'Space') keys.space = false; 
        };

        // --- LÓGICA PRINCIPAL ---
        function update() {
            if (!cat) return;

            // Movimiento lateral
            let currentSpeed = isPowerUp ? player.speed * 2 : player.speed;
            if (keys.d) {
                cat.position.x += currentSpeed;
                cat.rotation.z -= 0.2; // Gira al correr
                cat.rotation.y = Math.PI/2;
            }
            if (keys.a) {
                cat.position.x -= currentSpeed;
                cat.rotation.z += 0.2;
                cat.rotation.y = -Math.PI/2;
            }

            // Salto y Gravedad
            if (keys.space && player.isGrounded) {
                player.velY = 0.25;
                player.isGrounded = false;
            }
            player.velY -= 0.01;
            cat.position.y += player.velY;

            if (cat.position.y < 0.5) {
                cat.position.y = 0.5;
                player.velY = 0;
                player.isGrounded = true;
            }

            // Colisiones con Atún
            items.forEach((item, index) => {
                item.rotation.z += 0.05; // Girar lata
                if (cat.position.distanceTo(item.position) < 0.8) {
                    scene.remove(item);
                    items.splice(index, 1);
                    score += 1;
                    document.getElementById('score').innerText = score;
                    activatePowerUp();
                }
            });

            // Colisiones con Obstáculos
            obstacles.forEach(obs => {
                if (cat.position.distanceTo(obs.position) < 0.8) {
                    cat.position.x -= 0.5; // Empuje hacia atrás
                    score = Math.max(0, score - 1);
                    document.getElementById('score').innerText = score;
                }
            });

            // Cámara dinámica
            camera.position.lerp(new THREE.Vector3(cat.position.x, cat.position.y + 3, 10), 0.1);
            camera.lookAt(cat.position.x, cat.position.y + 1, 0);
        }

        function activatePowerUp() {
            isPowerUp = true;
            document.getElementById('msg').style.display = 'block';
            setTimeout(() => {
                isPowerUp = false;
                document.getElementById('msg').style.display = 'none';
            }, 3000);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
